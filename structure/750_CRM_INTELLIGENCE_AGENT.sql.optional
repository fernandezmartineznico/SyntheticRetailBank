-- ============================================================
-- CRM INTELLIGENCE AGENT - Customer 360° Cortex AI Agent
-- Created on: 2025-11-04
-- ============================================================
--
-- OVERVIEW:
-- Creates a Snowflake Cortex AI Agent that provides natural language
-- access to comprehensive customer intelligence via the CRMA_SEMANTIC_VIEW.
--
-- AGENT CAPABILITIES:
-- - Natural language customer queries
-- - PEP and sanctions screening insights
-- - Risk assessment and compliance monitoring
-- - Customer segmentation and portfolio analysis
-- - Fraud detection and anomaly investigation
--
-- PREREQUISITES:
-- - CRMA_SEMANTIC_VIEW must be deployed (700_CRM_SEMANTIC_VIEW.sql)
-- - GRANT CREATE AGENT on snowflake_intelligence.agents (from 000_database_setup.sql)
-- - ACCOUNTADMIN role or equivalent permissions
--
-- ============================================================

USE DATABASE AAA_DEV_SYNTHETIC_BANK;
USE SCHEMA CRM_AGG_001;

-- ============================================================
-- CREATE CRM INTELLIGENCE AGENT
-- ============================================================

CREATE OR REPLACE AGENT SNOWFLAKE_INTELLIGENCE.AGENTS.CRM_INTELLIGENCE_AGENT
  WITH PROFILE='{"display_name": "CRM Intelligence Agent - Customer 360°"}'
  COMMENT='AI Agent providing natural language access to comprehensive customer intelligence, risk assessment, compliance screening, and portfolio analytics'
  FROM SPECIFICATION $$
[
  {
    "instructions": {
      "response": "You are the CRM Intelligence Agent for AAA Synthetic Bank. Provide clear, actionable insights about customers, always prioritizing compliance and risk assessment. When discussing high-risk customers or compliance flags, be precise and include relevant risk scores and ratings. Format responses in a business-friendly way with clear headers and bullet points when appropriate. Always cite specific customer IDs when referencing individuals."
    },
    "tools": [
      { 
        "tool_spec": { 
          "type": "cortex_analyst_text_to_sql", 
          "name": "CRM_Analyst", 
          "description": "Natural language query interface for comprehensive customer intelligence including demographics, risk scoring, PEP/sanctions screening, account portfolios, compliance flags, and fraud detection across 48 customer attributes. Supports queries about customer segmentation, risk assessment, compliance monitoring, and relationship management."
        } 
      }
    ],
    "tool_resources": {
      "CRM_Analyst": {
        "semantic_view": "AAA_DEV_SYNTHETIC_BANK.CRM_AGG_001.CRMA_SEMANTIC_VIEW"
      }
    }
  }
]
$$;

-- ============================================================
-- GRANT PERMISSIONS
-- ============================================================

GRANT USAGE ON AGENT SNOWFLAKE_INTELLIGENCE.AGENTS.CRM_INTELLIGENCE_AGENT TO ROLE ACCOUNTADMIN;
GRANT USAGE ON AGENT SNOWFLAKE_INTELLIGENCE.AGENTS.CRM_INTELLIGENCE_AGENT TO ROLE PUBLIC;

-- ============================================================
-- DEPLOYMENT COMPLETE!
-- ============================================================
--
-- AGENT CREATED: CRM_INTELLIGENCE_AGENT
-- Location: SNOWFLAKE_INTELLIGENCE.AGENTS.CRM_INTELLIGENCE_AGENT
--
-- HOW TO USE:
--
-- 1. In Snowsight, navigate to: Projects > AI & ML > Agents
-- 2. Find "CRM Intelligence Agent - Customer 360°"
-- 3. Click to open the agent chat interface
-- 4. Start asking questions in natural language!
--
-- EXAMPLE QUERIES TO TRY:
--
-- Customer Intelligence:
-- - "Show me all PLATINUM customers in Switzerland"
-- - "How many customers do we have by account tier?"
-- - "Find customers who joined in the last 90 days"
--
-- Risk & Compliance:
-- - "Which customers require PEP review?"
-- - "Show me all high-risk customers with CRITICAL ratings"
-- - "Find customers with exact sanctions matches"
-- - "What is our risk distribution by customer tier?"
--
-- Portfolio Analysis:
-- - "Which customers have both investment and business accounts?"
-- - "Show me multi-currency customers with 3+ currencies"
-- - "What's the average number of accounts per customer tier?"
--
-- Fraud Detection:
-- - "Find customers with anomalous transaction patterns"
-- - "Show me high-risk customers with fraud indicators"
-- - "Which premium customers have suspicious activity flags?"
--
-- Geographic Analysis:
-- - "What is our customer distribution by country?"
-- - "Show me all customers in Germany and France"
-- - "Find GOLD tier customers in Switzerland with high income"
--
-- AGENT FEATURES:
-- ✅ Understands 200+ synonyms (client, customer, account holder, etc.)
-- ✅ Provides context-aware responses with risk insights
-- ✅ Formats results in business-friendly tables and summaries
-- ✅ Maintains conversation history for follow-up questions
-- ✅ Access to real-time customer data (refreshed hourly)
--
-- VERIFICATION:
-- To verify the agent was created successfully:
-- SHOW AGENTS LIKE 'CRM%' IN SNOWFLAKE_INTELLIGENCE.AGENTS;
--
-- To test the agent via SQL:
-- SELECT SNOWFLAKE.CORTEX.COMPLETE_AGENT(
--   'snowflake_intelligence.agents.crm_intelligence_agent',
--   'How many PLATINUM customers do we have?'
-- ) AS response;
--
-- ============================================================

